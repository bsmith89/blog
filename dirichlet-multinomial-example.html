<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <title>
Deep Ecology - The Dirichlet-Multinomial in PyMC3
  </title>
<!-- #feeds -->
<link href="//blog.byronjsmith.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Deep Ecology Full Atom Feed" />
<link href="//blog.byronjsmith.com/feeds/category/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Deep Ecology Categories Atom Feed" />
<!-- /#feeds -->
  <link rel="stylesheet" type="text/css" href="//blog.byronjsmith.com/theme/css/main.css" />
  <link rel="stylesheet" type="text/css" href="//blog.byronjsmith.com/theme/css/pygment.css" />
<!-- #google-analytics-script -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40659359-2', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script>
<!-- /#google-analytics-script -->


</head>

<body id="main">
<!-- #github-ribbon -->
<a href="https://github.com/bsmith89">
  <img style="position: absolute; top: 0; right: 0; border: 0;"
      src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
      alt="Fork me on GitHub"
      id="gh-ribbon" />
</a>
<!-- /#github-ribbon -->


  <div id="all-text">
    <header id="main-banner" class="banner">
<!-- page-chrome -->
<h1 id="blog-title">
  <a href="//blog.byronjsmith.com/">
    Deep Ecology
    <span id="blog-subtitle">
      A blog of the new microbiology.
    </span>
  </a>
</h1>

<nav>
  <ul>
    <li>
      <a href="//blog.byronjsmith.com/about.html"
         >
        About
      </a>
    </li>
    <li>
      <a href="//blog.byronjsmith.com/category/biology.html"
>
        Biology
      </a>
    </li>
    <li>
      <a href="//blog.byronjsmith.com/category/computing.html"
>
        Computing
      </a>
    </li>
    <li>
      <a href="//blog.byronjsmith.com/category/data.html"
        class="active"
>
        Data
      </a>
    </li>
    <li>
      <a href="//blog.byronjsmith.com/category/education.html"
>
        Education
      </a>
    </li>
    <li>
      <a href="//blog.byronjsmith.com/category/misc.html"
>
        Misc.
      </a>
    </li>
  </ul>
</nav>
<!-- /page-chrome -->
    </header>
    <div id="page-content">
<article itemscope itemtype="https://schema.org/BlogPosting">
  <header>
    <h1 id="page-title" class="headline" itemprop="headline">
      <a href="//blog.byronjsmith.com/dirichlet-multinomial-example.html" rel="bookmark"
         title="Permalink to The Dirichlet-Multinomial in PyMC3">
        The Dirichlet-Multinomial in PyMC3
      </a>
    </h1>
    <h3 id="page-subtitle" class="headline subtitle">
      Modeling Overdispersion in Compositional Count Data
    </h3>
  </header>
<footer class="article-info">

  <div class="published">
    <span class="info-tag">published:</span>
    <span class="info-value" itemprop="datePublished">
      <abbr title="2021-01-29 14:00:00-05:00">
        Friday, January 29, 2021
      </abbr>
    </span>
  </div>



  <div class="category">
    <span class="info-tag">category:</span>
    <span class="info-value" itemprop="articleSection">
      <a href="//blog.byronjsmith.com/category/data.html">
        Data
      </a>
    </span>
  </div>

  <div class="tags">
    <span class="info-tag">tags:</span>
    <span class="info-value" itemprop="keywords">
      <ul class="article-tag-list">
        <li>
          <a href="//blog.byronjsmith.com/tag/pymc3.html">
            pymc3
          </a>
        </li>
        <li>
          <a href="//blog.byronjsmith.com/tag/bayesian.html">
            bayesian
          </a>
        </li>
        <li>
          <a href="//blog.byronjsmith.com/tag/tutorial.html">
            tutorial
          </a>
        </li>
        <li>
          <a href="//blog.byronjsmith.com/tag/python.html">
            python
          </a>
        </li>
        <li>
          <a href="//blog.byronjsmith.com/tag/statistics.html">
            statistics
          </a>
        </li>
      </ul>
    </span>
  </div><!-- /.tags -->

</footer>
  <div class="article-content" itemprop="articleBody">
    <p><em>Having just spent a few too many hours
<a href="https://github.com/pymc-devs/pymc3/pull/4373">working on the Dirichlet-multinomial distribution</a>
in <a href="https://github.com/pymc-devs/pymc3">PyMC3</a>,
I thought I'd convert the demo notebook
<a href="https://github.com/pymc-devs/pymc-examples/pull/18">I also contributed</a>
into a blog post.</em></p>
<p>This example (exported and minimally edited from a Jupyter Notebook)
demonstrates the use of a Dirichlet mixture of
multinomials (a.k.a
<a href="https://en.wikipedia.org/wiki/Dirichlet-multinomial_distribution">Dirichlet-multinomial</a>
or DM) to model categorical count data.  Models like this one are important in
a variety of areas, including natural language processing, ecology,
bioinformatics, and more.</p>
<p>The Dirichlet-multinomial can be understood as draws from a <a href="https://en.wikipedia.org/wiki/Multinomial_distribution">Multinomial
distribution</a> where
each sample has a slightly different probability vector, which is itself drawn
from a common <a href="https://en.wikipedia.org/wiki/Dirichlet_distribution">Dirichlet
distribution</a>.  This
contrasts with the Multinomial distribution, which assumes that all
observations arise from a single fixed probability vector.  This enables the
Dirichlet-multinomial to accommodate more variable (a.k.a, over-dispersed)
count data than the Multinomial.</p>
<p>Other examples of over-dispersed count distributions are the
<a href="https://en.wikipedia.org/wiki/Beta-binomial_distribution">Beta-binomial</a>
(which can be thought of as a special case of the DM) or the <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">Negative
binomial</a>
distributions.</p>
<p>The DM is also an example of marginalizing a mixture distribution over its
latent parameters.  This notebook will demonstrate the performance benefits
that come from taking that approach.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Import modules.</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Set seed for reproducibility.</span>
<span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>

<span class="c1"># Set figure style.</span>
<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>
</code></pre></div>

<h2>Simulation data</h2>
<p>Let us simulate some over-dispersed, categorical count data
for this example.</p>
<p>Here we are simulating from the DM distribution itself,
so it is perhaps tautological to fit that model,
but rest assured that data like these really do appear in
the counts of different:
(1) <a href="https://doi.org/10.1145/1102351.1102420">words in a text corpus</a>,
(2) <a href="https://doi.org/10.12688/f1000research.8900.2">types of RNA molecules in a cell</a>,
(3) <a href="https://doi.org/10.2307/2981696">items purchased by shoppers</a>.</p>
<p>Here we will discuss a community ecology example, pretending that we have
observed counts of $k=5$ different tree species in $n=10$ different forests.</p>
<p>Our simulation will produce a two-dimensional matrix of integers (counts) where
each row, (zero-)indexed by $i \in (0...n-1)$, is an observation (different
forest), and each column $j \in (0...k-1)$ is a category (tree species).
We'll parameterize this distribution with three things:
- $\mathrm{frac}$ : the expected fraction of each species,
  a $k$-dimensional vector on the simplex (i.e. sums-to-one)
- $\mathrm{totalcount}$ : the total number of items tallied in each observation,
- $\mathrm{conc}$ : the concentration, controlling the overdispersion of our data,
  where larger values result in our distribution more closely approximating the multinomial.</p>
<p>Here, and throughout this notebook, we've used a
<a href="https://mc-stan.org/docs/2_26/stan-users-guide/reparameterizations.html#dirichlet-priors">convenient reparameterization</a>
of the Dirichlet distribution from one to two parameters,
$\alpha=\mathrm{conc} \times \mathrm{frac}$,
as this fits our desired interpretation.</p>
<p>Each observation from the DM is simulated by:
1. first obtaining a value on the $k$-simplex simulated as
   $p_i \sim \mathrm{Dirichlet}(\alpha=\mathrm{conc} \times \mathrm{frac})$,
2. and then simulating
   $\mathrm{counts}_i \sim \mathrm{Multinomial}(\mathrm{totalcount}, p_i)$.</p>
<p>Notice that each observation gets its <em>own</em> latent parameter $p_i$, simulated
independently from a common Dirichlet distribution.</p>
<div class="highlight"><pre><span></span><code><span class="n">true_conc</span> <span class="o">=</span> <span class="mf">6.0</span>
<span class="n">true_frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
<span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_frac</span><span class="p">)</span>  <span class="c1"># Number of different tree species observed</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Number of forests observed</span>
<span class="n">total_count</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">true_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">dirichlet</span><span class="p">(</span><span class="n">true_conc</span> <span class="o">*</span> <span class="n">true_frac</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">observed_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">total_count</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p_i</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span> <span class="k">for</span> <span class="n">p_i</span> <span class="ow">in</span> <span class="n">true_p</span><span class="p">])</span>

<span class="n">observed_counts</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>array([[33,  8,  4,  1,  4],
       [22, 28,  0,  0,  0],
       [35, 11,  2,  2,  0],
       [32,  1,  7, 10,  0],
       [24, 22,  4,  0,  0],
       [28, 13,  9,  0,  0],
       [19,  4, 21,  6,  0],
       [26, 17,  1,  6,  0],
       [32, 16,  0,  2,  0],
       [10, 30,  5,  5,  0]])
</code></pre></div>

<h2>Multinomial model</h2>
<p>The first model that we will fit to these data is a plain multinomial model,
where the only parameter is the expected fraction of each category,
$\mathrm{frac}$, which we will give a Dirichlet prior.
While the uniform prior ($\alpha_j=1$ for each $j$) works well, if we have
independent beliefs about the fraction of each tree, we could encode this into
our prior, e.g.  increasing the value of $\alpha_j$ where we expect a higher
fraction of species-$j$.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_multinomial</span><span class="p">:</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Multinomial</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">total_count</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_counts</span><span class="p">)</span>

<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model_multinomial</span><span class="p">)</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_9_0.svg" title="Plain multinomial model plate diagram.", class="half-width"></p>
<p>Interestingly, NUTS frequently runs into numerical problems on this model, perhaps an example of the
<a href="https://statmodeling.stat.columbia.edu/2008/05/13/the_folk_theore/">"Folk Theorem of Statistical Computing"</a>.</p>
<p>Because of a couple of identities of the multinomial distribution,
we could reparameterize this model in a number of ways&mdash;we
would obtain equivalent models by exploding our $n$ observations
of $\mathrm{totalcount}$ items into $(n \times \mathrm{totalcount})$
independent categorical trials, or collapsing them down into
one Multinomial draw with $(n \times \mathrm{totalcount})$ items.
(Importantly, this is <em>not</em> true for the DM distribution.)</p>
<p>Rather than <em>actually</em> fixing our problem through reparameterization,
here we'll instead switch to the Metropolis step method,
which ignores some of the geometric pathologies of our na√Øve model.</p>
<p><strong>Important</strong>: switching to Metropolis does not not <em>fix</em> our model's issues, rather it <em>sweeps them under the rug</em>.
In fact, if you try running this model with NUTS (PyMC3's default step method), it will break loudly during sampling.
When that happens, this should be a <strong>red alert</strong> that there is something wrong in our model.</p>
<p>You'll also notice below that we have to increase considerably the number of draws we take from the posterior;
this is because Metropolis is much less efficient at
exploring the posterior than NUTS.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">model_multinomial</span><span class="p">:</span>
    <span class="n">trace_multinomial</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">draws</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">5e3</span><span class="p">),</span> <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">Metropolis</span><span class="p">(),</span> <span class="n">return_inferencedata</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Multiprocess sampling (4 chains in 2 jobs)
Metropolis: [frac]
100.00% [24000/24000 00:07&lt;00:00 Sampling 4 chains, 0 divergences]
Sampling 4 chains for 1_000 tune and 5_000 draw iterations (4_000 + 20_000 draws total) took 18 seconds.
The number of effective samples is smaller than 10% for some parameters.
</code></pre></div>

<p>Let's ignore the warning about inefficient sampling for now.</p>
<div class="highlight"><pre><span></span><code><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">trace_multinomial</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">]);</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_13_0.png" title="Trace and posterior density for frac parameters in plain multinomial model."></p>
<p>The trace plots look fairly good;
visually, each parameter appears to be moving around the posterior well,
although some sharp parts of the KDE plot suggests that
sampling sometimes gets stuck in one place for a few steps.</p>
<div class="highlight"><pre><span></span><code><span class="n">summary_multinomial</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_multinomial</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">])</span>
<span class="n">summary_multinomial</span> <span class="o">=</span> <span class="n">summary_multinomial</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">ess_mean_per_sec</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ess_mean</span> <span class="o">/</span> <span class="n">trace_multinomial</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sampling_time</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">summary_multinomial</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
      <th>ess_mean_per_sec</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>frac[0]</th>
      <td>0.518</td>
      <td>0.022</td>
      <td>0.474</td>
      <td>0.556</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2020.0</td>
      <td>2015.0</td>
      <td>2028.0</td>
      <td>2516.0</td>
      <td>1.00</td>
      <td>110.249714</td>
    </tr>
    <tr>
      <th>frac[1]</th>
      <td>0.299</td>
      <td>0.021</td>
      <td>0.261</td>
      <td>0.338</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1941.0</td>
      <td>1941.0</td>
      <td>1938.0</td>
      <td>2310.0</td>
      <td>1.00</td>
      <td>105.937968</td>
    </tr>
    <tr>
      <th>frac[2]</th>
      <td>0.107</td>
      <td>0.014</td>
      <td>0.083</td>
      <td>0.133</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1259.0</td>
      <td>1259.0</td>
      <td>1257.0</td>
      <td>1729.0</td>
      <td>1.00</td>
      <td>68.715045</td>
    </tr>
    <tr>
      <th>frac[3]</th>
      <td>0.066</td>
      <td>0.011</td>
      <td>0.046</td>
      <td>0.087</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>767.0</td>
      <td>767.0</td>
      <td>734.0</td>
      <td>1260.0</td>
      <td>1.01</td>
      <td>41.862144</td>
    </tr>
    <tr>
      <th>frac[4]</th>
      <td>0.010</td>
      <td>0.005</td>
      <td>0.003</td>
      <td>0.019</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>516.0</td>
      <td>516.0</td>
      <td>457.0</td>
      <td>538.0</td>
      <td>1.01</td>
      <td>28.162798</td>
    </tr>
  </tbody>
</table>
</div>

<p>Likewise, diagnostics in the parameter summary table all look fine.
Here I've added a column estimating the effective sample size per second of
sampling.</p>
<p>Nonetheless, the fact that we were unable to use NUTS is still a red flag, and
we should be very cautious in using these results.</p>
<div class="highlight"><pre><span></span><code><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_multinomial</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">y_tick</span><span class="p">,</span> <span class="n">frac_j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">(),</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">true_frac</span><span class="p">))):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">frac_j</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">y_tick</span> <span class="o">-</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">y_tick</span> <span class="o">+</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_17_0.png" title="Forest-plot of <code>frac</code> parameter credible intervals compared to true parameter values.", class="half-width"></p>
<p>Here we've drawn a forest-plot, showing the mean and 94% HDIs from our posterior approximation.
Interestingly, because we know what the underlying
frequencies are for each species (dashed lines), we can comment on the accuracy
of our inferences.
And now the issues with our model become apparent;
notice that the 94% HDIs <em>don't include the true values</em> for
tree species 0, 2, 3.
We might have seen <em>one</em> HDI miss, but <em>three</em>???</p>
<p>...what's going on?</p>
<p>Let's troubleshoot this model using a posterior-predictive check, comparing our
data to simulated data conditioned on our posterior estimates.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">model_multinomial</span><span class="p">:</span>
    <span class="n">ppc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">fast_sample_posterior_predictive</span><span class="p">(</span>
        <span class="n">trace</span><span class="o">=</span><span class="n">trace_multinomial</span><span class="p">,</span>
        <span class="n">keep_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Concatenate with InferenceData object</span>
<span class="n">trace_multinomial</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc</span><span class="p">))</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">trace_multinomial</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="o">.</span><span class="n">counts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_count</span><span class="p">),</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Post.Pred.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="p">(</span><span class="n">trace_multinomial</span><span class="o">.</span><span class="n">observed_data</span><span class="o">.</span><span class="n">counts</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_count</span><span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
        <span class="n">true_frac</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_count</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;species-</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">);</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_20_0.png" title="Posterior predictive distribution vs. observed count data."></p>
<p>Here we're plotting histograms of the predicted counts against the observed
counts for each species.</p>
<p><em>(Notice that the y-axis isn't full height and clips the distributions for species-4 in purple.)</em></p>
<p>And now we can start to see why our posterior HDI deviates from the <em>true</em>
parameters for three of five species (vertical lines).
See that for all of the species the observed counts are frequently quite far
from the predictions conditioned on the posterior distribution.
This is particularly obvious for (e.g.) species-2 where we have one observation
of more than 20 trees of this species, despite the posterior predicitive mass
being concentrated far below that.</p>
<p>This is overdispersion at work, and a clear sign that we need to adjust our
model to accomodate it.</p>
<p>Posterior predictive checks are one of the best ways to diagnose model misspecification,
and this example is no different.</p>
<h2>Dirichlet-Multinomial Model - Explicit Mixture</h2>
<p>Let's go ahead and model our data using the DM distribution.</p>
<p>For this model we'll keep the same prior on the expected frequencies of each
species, $\mathrm{frac}$.
We'll also add a strictly positive parameter, $\mathrm{conc}$, for the concentration.</p>
<p>In this iteration of our model we'll explicitly include the latent multinomial
probability, $p_i$, modeling the $\mathrm{true\_p}_i$ from our simulations (which we would not
observe in the real world).</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_dm_explicit</span><span class="p">:</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">conc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s2">&quot;conc&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">frac</span> <span class="o">*</span> <span class="n">conc</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Multinomial</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">total_count</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_counts</span><span class="p">)</span>

<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model_dm_explicit</span><span class="p">)</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_24_0.svg" title="Explicit Dirichlet mixture of multinomials model plate diagram", class="half-width"></p>
<p>Compare this diagram to the first.
Here the latent, Dirichlet distributed $p$ separates the multinomial from the expected frequencies, $\mathrm{frac}$,
accounting for overdispersion of counts relative to the simple multinomial model.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">model_dm_explicit</span><span class="p">:</span>
    <span class="n">trace_dm_explicit</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">return_inferencedata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 2 jobs)
NUTS: [p, conc, frac]
100.00% [8000/8000 02:47&lt;00:00 Sampling 4 chains, 11 divergences]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 182 seconds.
There were 3 divergences after tuning. Increase `target_accept` or reparameterize.
There was 1 divergence after tuning. Increase `target_accept` or reparameterize.
There were 7 divergences after tuning. Increase `target_accept` or reparameterize.
The acceptance probability does not match the target. It is 0.9041835811665464, but should be close to 0.8. Try to increase the number of tuning steps.
The estimated number of effective samples is smaller than 200 for some parameters.
</code></pre></div>

<p>We got a warning, although we'll ignore it for now.
More interesting is how much longer it took to sample this model than the
first.
This may be because our model has an additional ~$(n \times k)$ parameters,
but it seems like there are other geometric challenges for NUTS as well.</p>
<p>We'll see if we can fix these in the next model, but for now let's take a look at the traces.</p>
<div class="highlight"><pre><span></span><code><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">trace_dm_explicit</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="s2">&quot;conc&quot;</span><span class="p">]);</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_28_0.png" title="Trace and posterior density plots for explicit mixture model."></p>
<p>Obviously some sampling issues, but it's hard to see where divergences are occurring.</p>
<div class="highlight"><pre><span></span><code><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_dm_explicit</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">y_tick</span><span class="p">,</span> <span class="n">frac_j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">(),</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">true_frac</span><span class="p">))):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">frac_j</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">y_tick</span> <span class="o">-</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">y_tick</span> <span class="o">+</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_30_0.png" title="Credible intervals versus true species fractions." class="half-width"></p>
<p>On the other hand, since we know the ground-truth for $\mathrm{frac}$,
we can congratulate ourselves that
the HDIs include the true values for all of our species!</p>
<p>Modeling this mixture has made our inferences robust to the overdispersion of counts,
while the plain multinomial is very sensitive.
Notice that the HDI is much wider than before for each $\mathrm{frac}_i$.
In this case that makes the difference between correct and incorrect inferences.</p>
<div class="highlight"><pre><span></span><code><span class="n">summary_dm_explicit</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_dm_explicit</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="s2">&quot;conc&quot;</span><span class="p">])</span>
<span class="n">summary_dm_explicit</span> <span class="o">=</span> <span class="n">summary_dm_explicit</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">ess_mean_per_sec</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ess_mean</span> <span class="o">/</span> <span class="n">trace_dm_explicit</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sampling_time</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">summary_dm_explicit</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
      <th>ess_mean_per_sec</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>frac[0]</th>
      <td>0.499</td>
      <td>0.063</td>
      <td>0.378</td>
      <td>0.613</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4058.0</td>
      <td>4058.0</td>
      <td>4115.0</td>
      <td>2871.0</td>
      <td>1.00</td>
      <td>22.319671</td>
    </tr>
    <tr>
      <th>frac[1]</th>
      <td>0.280</td>
      <td>0.053</td>
      <td>0.183</td>
      <td>0.379</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4549.0</td>
      <td>4549.0</td>
      <td>4506.0</td>
      <td>2604.0</td>
      <td>1.00</td>
      <td>25.020252</td>
    </tr>
    <tr>
      <th>frac[2]</th>
      <td>0.117</td>
      <td>0.034</td>
      <td>0.057</td>
      <td>0.182</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3236.0</td>
      <td>3236.0</td>
      <td>3184.0</td>
      <td>2919.0</td>
      <td>1.00</td>
      <td>17.798535</td>
    </tr>
    <tr>
      <th>frac[3]</th>
      <td>0.089</td>
      <td>0.030</td>
      <td>0.038</td>
      <td>0.144</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>2721.0</td>
      <td>2721.0</td>
      <td>2605.0</td>
      <td>2643.0</td>
      <td>1.00</td>
      <td>14.965950</td>
    </tr>
    <tr>
      <th>frac[4]</th>
      <td>0.015</td>
      <td>0.011</td>
      <td>0.001</td>
      <td>0.036</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>163.0</td>
      <td>163.0</td>
      <td>112.0</td>
      <td>120.0</td>
      <td>1.03</td>
      <td>0.896527</td>
    </tr>
    <tr>
      <th>conc</th>
      <td>6.143</td>
      <td>2.031</td>
      <td>2.739</td>
      <td>9.910</td>
      <td>0.047</td>
      <td>0.033</td>
      <td>1857.0</td>
      <td>1857.0</td>
      <td>1799.0</td>
      <td>2662.0</td>
      <td>1.00</td>
      <td>10.213807</td>
    </tr>
  </tbody>
</table>
</div>

<p>This is great, but <em>we can do better</em>.
The larger $\hat{R}$ value for $\mathrm{frac}_4$ is mildly concerning, and it's surprising
that our $\mathrm{ESS} \; \mathrm{sec}^{-1}$ is relatively small.</p>
<h2>Dirichlet-Multinomial Model - Marginalized</h2>
<p>Happily, the Dirichlet distribution is conjugate to the multinomial
and therefore there's a convenient, closed-form for the marginalized
distribution, i.e. the Dirichlet-multinomial distribution, which was added to PyMC3 in <a href="https://github.com/pymc-devs/pymc3/releases/tag/v3.11.0">3.11.0</a>.</p>
<p>Let's take advantage of this, marginalizing out the explicit latent parameter, $p_i$,
replacing the combination of this node and the multinomial
with the DM to make an equivalent model.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_dm_marginalized</span><span class="p">:</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Dirichlet</span><span class="p">(</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">conc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Lognormal</span><span class="p">(</span><span class="s2">&quot;conc&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">DirichletMultinomial</span><span class="p">(</span>
        <span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">total_count</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">frac</span> <span class="o">*</span> <span class="n">conc</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_counts</span>
    <span class="p">)</span>

<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model_dm_marginalized</span><span class="p">)</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_36_0.svg" title="Marginalized Dirichlet-multinomial model plate diagram." class="half-width"></p>
<p>The plate diagram shows that we've collapsed what had been the latent Dirichlet and the multinomial
nodes together into a single DM node.</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">model_dm_marginalized</span><span class="p">:</span>
    <span class="n">trace_dm_marginalized</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">return_inferencedata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 2 jobs)
NUTS: [conc, frac]
100.00% [8000/8000 00:17&lt;00:00 Sampling 4 chains, 0 divergences]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 34 seconds.
</code></pre></div>

<p>It samples much more quickly and without any of the warnings from before!</p>
<div class="highlight"><pre><span></span><code><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">trace_dm_marginalized</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="s2">&quot;conc&quot;</span><span class="p">]);</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_40_0.png" title="Trace and posterior density plots for marginalized mixture model."></p>
<p>Trace plots look fuzzy and KDEs are clean.</p>
<div class="highlight"><pre><span></span><code><span class="n">summary_dm_marginalized</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_dm_marginalized</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="s2">&quot;conc&quot;</span><span class="p">])</span>
<span class="n">summary_dm_marginalized</span> <span class="o">=</span> <span class="n">summary_dm_marginalized</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">ess_mean_per_sec</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ess_mean</span> <span class="o">/</span> <span class="n">trace_dm_marginalized</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sampling_time</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">summary_dm_marginalized</span><span class="o">.</span><span class="n">r_hat</span> <span class="o">&lt;</span> <span class="mf">1.03</span><span class="p">)</span>

<span class="n">summary_dm_marginalized</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
      <th>ess_mean_per_sec</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>frac[0]</th>
      <td>0.500</td>
      <td>0.063</td>
      <td>0.388</td>
      <td>0.621</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4543.0</td>
      <td>4543.0</td>
      <td>4609.0</td>
      <td>2932.0</td>
      <td>1.0</td>
      <td>133.853339</td>
    </tr>
    <tr>
      <th>frac[1]</th>
      <td>0.282</td>
      <td>0.054</td>
      <td>0.177</td>
      <td>0.381</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>6048.0</td>
      <td>5875.0</td>
      <td>6022.0</td>
      <td>2937.0</td>
      <td>1.0</td>
      <td>178.196124</td>
    </tr>
    <tr>
      <th>frac[2]</th>
      <td>0.116</td>
      <td>0.035</td>
      <td>0.057</td>
      <td>0.183</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>4317.0</td>
      <td>4275.0</td>
      <td>4229.0</td>
      <td>3243.0</td>
      <td>1.0</td>
      <td>127.194555</td>
    </tr>
    <tr>
      <th>frac[3]</th>
      <td>0.087</td>
      <td>0.029</td>
      <td>0.035</td>
      <td>0.143</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>2897.0</td>
      <td>2897.0</td>
      <td>2791.0</td>
      <td>2580.0</td>
      <td>1.0</td>
      <td>85.356179</td>
    </tr>
    <tr>
      <th>frac[4]</th>
      <td>0.015</td>
      <td>0.011</td>
      <td>0.000</td>
      <td>0.034</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>3064.0</td>
      <td>2898.0</td>
      <td>2685.0</td>
      <td>2072.0</td>
      <td>1.0</td>
      <td>90.276608</td>
    </tr>
    <tr>
      <th>conc</th>
      <td>6.213</td>
      <td>2.032</td>
      <td>2.692</td>
      <td>9.812</td>
      <td>0.037</td>
      <td>0.027</td>
      <td>3017.0</td>
      <td>2866.0</td>
      <td>3063.0</td>
      <td>3303.0</td>
      <td>1.0</td>
      <td>88.891817</td>
    </tr>
  </tbody>
</table>
</div>

<p>We see that $\hat{R}$ is close to $1$ everywhere
and $\mathrm{ESS} \; \mathrm{sec}^{-1}$ is much higher.
Our reparameterization (marginalization) has greatly improved the sampling!
(And, thankfully, the HDIs look similar to the other model.)</p>
<p>This all looks very good, but what if we didn't have the ground-truth?</p>
<p>Posterior predictive checks to the rescue (again)!</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">model_dm_marginalized</span><span class="p">:</span>
    <span class="n">ppc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">fast_sample_posterior_predictive</span><span class="p">(</span><span class="n">trace_dm_marginalized</span><span class="p">,</span> <span class="n">keep_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Concatenate with InferenceData object</span>
<span class="n">trace_dm_marginalized</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="o">=</span><span class="n">ppc</span><span class="p">))</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_trace</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">trace_dm_marginalized</span><span class="p">,</span> <span class="n">trace_multinomial</span><span class="p">],</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">_trace</span><span class="o">.</span><span class="n">posterior_predictive</span><span class="o">.</span><span class="n">counts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_count</span><span class="p">),</span>
            <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Post.Pred.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="p">(</span><span class="n">_trace</span><span class="o">.</span><span class="n">observed_data</span><span class="o">.</span><span class="n">counts</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">total_count</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">true_frac</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_count</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;species-</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.96</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
        <span class="n">xycoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Multinomial&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Dirichlet-multinomial&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">);</span>
</code></pre></div>

<p><img src="//blog.byronjsmith.com/static/images/dm_example_45_0.png" title="Posterior predictive distribution vs. observed counts for DM vs. multinomial models."></p>
<p><em>(Notice, again, that the y-axis isn't full height, and clips the distributions for species-4 in purple.)</em></p>
<p>Compared to the multinomial (plots on the right), PPCs for the DM (left) show that the observed data is
an entirely reasonable realization of our model.
This is great news!</p>
<h2>Model Comparison</h2>
<p>Let's go a step further and try to put a number on how much better our DM model is
relative to the raw multinomial.
We'll use leave-one-out cross validation to compare the
out-of-sample predictive ability of the two.</p>
<div class="highlight"><pre><span></span><code><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;multinomial&quot;</span><span class="p">:</span> <span class="n">trace_multinomial</span><span class="p">,</span> <span class="s2">&quot;dirichlet_multinomial&quot;</span><span class="p">:</span> <span class="n">trace_dm_marginalized</span><span class="p">},</span> <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span>
<span class="p">)</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>loo</th>
      <th>p_loo</th>
      <th>d_loo</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>loo_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dirichlet_multinomial</th>
      <td>0</td>
      <td>-96.382639</td>
      <td>4.322324</td>
      <td>0.000000</td>
      <td>1.0</td>
      <td>5.861086</td>
      <td>0.000000</td>
      <td>False</td>
      <td>log</td>
    </tr>
    <tr>
      <th>multinomial</th>
      <td>1</td>
      <td>-161.543594</td>
      <td>24.431986</td>
      <td>65.160955</td>
      <td>0.0</td>
      <td>22.336271</td>
      <td>18.207668</td>
      <td>True</td>
      <td>log</td>
    </tr>
  </tbody>
</table>
</div>

<p>Unsurprisingly, the DM outclasses the multinomial by a mile, assigning a weight of nearly
100% to the over-dispersed model.
We can conclude that between the two, the DM should be greatly favored for prediction,
parameter inference, etc.</p>
<h2>Conclusions</h2>
<p>Obviously the DM is not a perfect model in every case, but it is often a better choice than the multinomial, much more robust while taking on just one additional parameter.</p>
<p>There are a number of shortcomings to the DM that we should keep in mind when selecting a model.
The biggest problem is that, while more flexible than the multinomial, the DM
still ignores the possibility of underlying correlations between categories.
If one of our tree species relies on another, for instance, the model we've used here
will not effectively account for this.
In that case, swapping the vanilla Dirichlet distribution for something fancier
(e.g. the <a href="https://en.wikipedia.org/wiki/Generalized_Dirichlet_distribution">Generalized Dirichlet</a> or
<a href="https://en.wikipedia.org/wiki/Logit-normal_distribution#Multivariate_generalization">Logistic-Multivariate Normal</a>)
may be worth considering.</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">w</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Last updated: Mon Jan 25 2021

Python implementation: CPython
Python version       : 3.9.1
IPython version      : 7.19.0

scipy     : 1.6.0
seaborn   : 0.11.1
pymc3     : 3.10.0
json      : 2.0.9
numpy     : 1.19.4
matplotlib: 3.3.3
arviz     : 0.11.0

Watermark: 2.1.0
</code></pre></div>
  </div>
  
</article>
<div class="comments">
  <h2>Comments</h2>
  <div id="disqus_thread"></div>
</div>
<script type="text/javascript">
    var disqus_shortname = 'byronjsmithblog';
    var disqus_identifier = 'dirichlet-multinomial-example.html';
    var disqus_title = "The Dirichlet-Multinomial in PyMC3";
    var disqus_url = '//blog.byronjsmith.com/dirichlet-multinomial-example.html';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript" rel="nofollow">
    comments powered by Disqus.
  </a>
</noscript>


    </div>
    <footer id="bottom">
<div id="extras">
  <div class="blogroll">
    <h2>blogroll</h2>
    <ul>
      <li><a href="http://ivory.idyll.org/blog/">Living in an Ivory Basement</a></li>
      <li><a href="https://www.johndcook.com/blog/">The Endeavor</a></li>
      <li><a href="https://statmodeling.stat.columbia.edu/">Andrew Gelman (and others)</a></li>
    </ul>
  </div>
  <div class="social">
    <h2>social</h2>
    <ul>
      <li><a  href="//blog.byronjsmith.com/feeds/all.atom.xml"
          type="application/atom+xml"
          rel="alternate">
        atom feed
      </a></li>
      <li><a href="https://twitter.com/ByronJSmith">twitter</a></li>
      <li><a href="https://linkedin.com/profile/view?id=76273001">linkedin</a></li>
      <li><a href="https://github.com/bsmith89">github</a></li>
    </ul>
  </div>
</div><!-- /#extras -->

<div id="site-info">
  <p id="site-copyright">
    The contents of this blog are licensed <a rel="license" href="https://creativecommons.org/licenses/by/4.0"><img title="CC-BY" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
  </p>
  <p id="theme-info">
    This <a href="https://github.com/bsmith89/blog-theme">theme</a>
    was originally created for
    <a href="http://blog.byronjsmith.com">blog.byronjsmith.com</a>
    and is powered by <a href="https://getpelican.com">Pelican</a>
  </p>
</div>
    </footer>
  </div>

<!-- #mathjax-scripts -->
<!-- Using MathJax, with the delimiters $ -->
<!-- Conflict with pygments for the .mo and .mi -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
  styles: {
  ".MathJax .mo, .MathJax .mi": {color: "black ! important"}}
  },
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']],processEscapes: true}
  });
  MathJax.Hub.Register.StartupHook("HTML-CSS Jax Ready",function () {
  var VARIANT = MathJax.OutputJax["HTML-CSS"].FONTDATA.VARIANT;
  VARIANT["normal"].fonts.unshift("MathJax_SansSerif");
  VARIANT["bold"].fonts.unshift("MathJax_SansSerif-bold");
  VARIANT["italic"].fonts.unshift("MathJax_SansSerif-italic");
  VARIANT["-tex-mathit"].fonts.unshift("MathJax_SansSerif-italic");
  });
  MathJax.Hub.Register.StartupHook("SVG Jax Ready",function () {
  var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;
  VARIANT["normal"].fonts.unshift("MathJax_SansSerif");
  VARIANT["bold"].fonts.unshift("MathJax_SansSerif-bold");
  VARIANT["italic"].fonts.unshift("MathJax_SansSerif-italic");
  VARIANT["-tex-mathit"].fonts.unshift("MathJax_SansSerif-italic");
  });
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<!-- /#mathjax-scripts -->


</body>
</html>